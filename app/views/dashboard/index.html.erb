<% content_for :page_title do %>
  <%= t('dashboard.index.page_title') %>
<% end %>

    <div class="flex flex-col lg:flex-row lg:items-start gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
      <!-- 左カラム -->
      <div class="w-full lg:w-auto lg:flex-[7_0_0%] flex flex-col gap-3 sm:gap-4 lg:gap-6">
        <!-- グラフ -->
        <%= render 'shared/card', class: 'min-w-0' do %>
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl font-bold"><%= t('dashboard.index.activity_graph') %></h3>
            <span class="badge badge-outline"><%= t('dashboard.index.week') %></span>
          </div>
          <div id="sleep-chart"
            data-series='<%= @series.to_json.html_safe %>'
            class="h-[250px] sm:h-[300px] lg:h-[350px]">
          </div>
        <% end %>

        <!-- 記録カード（モバイル） -->
        <%= render 'shared/card', class: 'lg:hidden min-w-0' do %>
          <div class="space-y-3">
            <%= button_to I18n.t('dashboard.index.wake_record'), record_wake_sleep_records_path,
                method: :post,
                class: "btn btn-primary btn-lg w-full #{'btn-disabled' if @unwoken_record.present?}",
                disabled: @unwoken_record.present?,
                data: { test: 'mobile-wake-button' } %>
            <%= button_to I18n.t('dashboard.index.bed_record'),
                (@unwoken_record ? record_bed_sleep_record_path(@unwoken_record) : "#"),
                method: :patch,
                class: "btn btn-secondary btn-lg w-full #{'btn-disabled' if @unwoken_record.nil?}",
                disabled: @unwoken_record.nil?,
                data: { test: 'mobile-bed-button' } %>
          </div>
        <% end %>

        <!-- 記録テーブル -->
        <%= render 'shared/sleep_records_table',
            records: @weekly_records,
            title: t('dashboard.index.this_week_records') %>

        <!-- 統計 -->
        <%= render 'shared/sleep_stats_cards',
            average_wake_hours: @weekly_average_wake_hours,
            average_sleep_hours: @weekly_average_sleep_hours,
            average_wake_time: @weekly_average_wake_time,
            average_bed_time: @weekly_average_bed_time,
            average_wake_hours_label: t('dashboard.index.weekly_average_wake_hours'),
            average_sleep_hours_label: t('dashboard.index.weekly_average_sleep_hours'),
            average_wake_time_label: t('dashboard.index.weekly_average_wake_time'),
            average_bed_time_label: t('dashboard.index.weekly_average_bed_time') %>

      </div>

      <!-- 右カラム -->
      <div class="hidden lg:flex lg:flex-[3_0_0%] flex-col gap-3 sm:gap-4 lg:gap-6">

        <!-- 記録カード -->
        <%= render 'shared/card' do %>
          <div class="space-y-3">
            <%= button_to I18n.t('dashboard.index.wake_record'), record_wake_sleep_records_path,
                method: :post,
                class: "btn btn-primary btn-lg w-full #{'btn-disabled' if @unwoken_record.present?}",
                disabled: @unwoken_record.present?,
                data: { test: 'desktop-wake-button' } %>
            <%= button_to I18n.t('dashboard.index.bed_record'),
                (@unwoken_record ? record_bed_sleep_record_path(@unwoken_record) : "#"),
                method: :patch,
                class: "btn btn-secondary btn-lg w-full #{'btn-disabled' if @unwoken_record.nil?}",
                disabled: @unwoken_record.nil?,
                data: { test: 'desktop-bed-button' } %>
          </div>
        <% end %>

        <!-- Googleカレンダー連携 -->
        <% if ENV["GOOGLE_CLIENT_ID"].present? && ENV["GOOGLE_CLIENT_SECRET"].present? %>
          <% if current_user&.google_authenticated? %>
            <%= render 'shared/card' do %>
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold">今日の予定</h3>
                <% if @today_events.present? %>
                  <span class="badge badge-outline badge-sm"><%= @today_events.size %>件</span>
                <% end %>
              </div>

              <% if @today_events.present? %>
                <div class="space-y-2">
                  <% @today_events.each_with_index do |event, index| %>
                    <div class="p-2 rounded hover:bg-base-200 transition-colors cursor-pointer" onclick="event_modal_<%= index %>.showModal()">
                      <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 mt-0.5">
                          <%= render 'shared/icon', type: 'calendar', size: 4, color: 'primary', flex_shrink: false %>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium"><%= event.summary || "(タイトルなし)" %></p>
                          <p class="text-xs text-base-content/60">
                            <% if event.start.date_time %>
                              <%= event.start.date_time.in_time_zone("Asia/Tokyo").strftime("%H:%M") %>
                              <% if event.end.date_time %>
                                - <%= event.end.date_time.in_time_zone("Asia/Tokyo").strftime("%H:%M") %>
                              <% end %>
                            <% elsif event.start.date %>
                              終日
                            <% end %>
                            <% if event.respond_to?(:calendar_summary) && event.calendar_summary.present? %>
                              <span class="ml-2 text-xs opacity-70">
                                • <%= event.calendar_summary %>
                              </span>
                            <% end %>
                          </p>
                        </div>
                      </div>
                    </div>

                    <!-- モーダル -->
                    <dialog id="event_modal_<%= index %>" class="modal">
                      <div class="modal-box">
                        <form method="dialog">
                          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                        </form>
                        <h3 class="font-bold text-lg mb-4"><%= event.summary || "(タイトルなし)" %></h3>
                        <%= render 'shared/event_details', event: event %>
                      </div>
                      <form method="dialog" class="modal-backdrop">
                        <button>close</button>
                      </form>
                    </dialog>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center py-4">
                  <p class="text-sm text-base-content/60">今日の予定はありません</p>
                </div>
              <% end %>

              <div class="pt-3 border-t border-base-300">
                <button onclick="new_event_modal.showModal()" class="btn btn-primary btn-sm w-full">
                  <%= render 'shared/icon', type: 'plus', size: 4, flex_shrink: false %>
                  予定を追加
                </button>
              </div>
            <% end %>
          <% else %>
            <%= render 'shared/card' do %>
              <div class="text-center">
                <h3 class="text-lg font-bold mb-2">Googleカレンダーと連携</h3>
                <p class="text-sm text-base-content/70 mb-4">カレンダーと連携して予定を表示しましょう</p>
                <%= button_to "Googleカレンダーと連携", user_google_oauth2_omniauth_authorize_path, method: :post, class: "btn btn-primary btn-sm", data: { turbo: false } %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
