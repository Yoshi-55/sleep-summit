<% content_for :page_title do %>
  <%= t('google_calendars.index.page_title') %>
<% end %>

    <div class="card bg-base-100 border border-base-300 mb-4">
      <div class="card-body p-4">
        <div class="flex items-center justify-between">
          <%= link_to google_calendars_path(date: (@date - 1.month).to_s), class: "btn btn-sm btn-outline" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          <% end %>

          <div class="flex items-center gap-2">
            <h2 class="text-2xl font-bold"><%= @date.strftime("%Y年%m月") %></h2>
          </div>

          <%= link_to google_calendars_path(date: (@date + 1.month).to_s), class: "btn btn-sm btn-outline" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          <% end %>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 border border-base-300">
      <div class="card-body p-0">
        <div class="grid grid-cols-7">
          <% %w[日 月 火 水 木 金 土].each_with_index do |day, index| %>
            <div class="p-1 sm:p-2 text-center text-xs sm:text-sm font-bold border-b border-base-300 <%= 'text-error' if index == 0 %> <%= 'text-info' if index == 6 %>">
              <%= day %>
            </div>
          <% end %>

          <%
            start_date = @date.beginning_of_month.beginning_of_week(:sunday)
            end_date = @date.end_of_month.end_of_week(:sunday)

            (start_date..end_date).each do |day|
              events_for_day = @month_events.select do |event|
                event_date = if event.start.date_time
                  event.start.date_time.in_time_zone('Asia/Tokyo').to_date
                elsif event.start.date
                  Date.parse(event.start.date.to_s)
                else
                  nil
                end
                event_date == day
              end

              is_today = day == Date.current
              is_current_month = day.month == @date.month

              # Build day cell classes
              day_classes = ["block", "min-h-[60px]", "sm:min-h-[100px]", "p-1", "sm:p-2", "border-b", "border-r", "border-base-300", "hover:bg-base-300/50", "transition-colors", "cursor-pointer"]
              day_classes << "bg-base-200/50" unless is_current_month
              day_classes << "bg-primary/10" << "ring-2" << "ring-primary" << "hover:bg-primary/20" if is_today

              # Build day number classes
              day_number_classes = ["text-xs", "sm:text-sm", "font-semibold", "mb-1"]
              day_number_classes << "text-base-content/40" unless is_current_month
              day_number_classes << "text-error" if day.wday == 0
              day_number_classes << "text-info" if day.wday == 6
          %>
            <div onclick="document.getElementById('day_modal_<%= day.strftime('%Y%m%d') %>').showModal();" class="<%= day_classes.join(' ') %>">
              <div class="<%= day_number_classes.join(' ') %>">
                <%= day.day %>
              </div>

              <!-- デスクトップ表示 -->
              <div class="hidden sm:block space-y-1">
                <% events_for_day.take(3).each do |event| %>
                  <button type="button" onclick="event.stopPropagation(); document.getElementById('event_modal_<%= event.id %>').showModal();"
                          class="w-full text-left text-xs p-1 rounded hover:opacity-80 transition-opacity truncate"
                          style="background-color: <%= event.respond_to?(:calendar_color) ? event.calendar_color : '#9fe1e7' %>; color: #000;">
                    <% if event.start.date_time %>
                      <%= event.start.date_time.in_time_zone('Asia/Tokyo').strftime("%H:%M") %>
                    <% end %>
                    <%= event.summary || t('google_calendars.index.no_title') %>
                  </button>
                <% end %>
                <% if events_for_day.size > 3 %>
                  <button type="button" onclick="event.stopPropagation(); document.getElementById('day_modal_<%= day.strftime('%Y%m%d') %>').showModal();"
                          class="text-xs text-primary hover:underline pl-1 cursor-pointer">
                    他 <%= events_for_day.size - 3 %>件
                  </button>
                <% end %>
              </div>

              <!-- モバイル表示 -->
              <% if events_for_day.present? %>
                <button type="button" onclick="event.stopPropagation(); document.getElementById('day_modal_<%= day.strftime('%Y%m%d') %>').showModal();"
                        class="sm:hidden w-full text-left">
                  <div class="flex items-center gap-0.5">
                    <% events_for_day.take(3).each do |event| %>
                      <div class="w-1.5 h-1.5 rounded-full flex-shrink-0"
                      style="background-color: <%= event.respond_to?(:calendar_color) ? event.calendar_color : '#9fe1e7' %>;"></div>
                    <% end %>
                    <% if events_for_day.size > 3 %>
                      <span class="text-[10px] text-primary ml-0.5">+<%= events_for_day.size - 3 %></span>
                    <% end %>
                  </div>
                </button>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- その日の全イベントを表示するモーダル -->
    <%
      start_date = @date.beginning_of_month.beginning_of_week(:sunday)
      end_date = @date.end_of_month.end_of_week(:sunday)

      (start_date..end_date).each do |day|
        events_for_day = @month_events.select do |event|
          event_date = if event.start.date_time
            event.start.date_time.in_time_zone('Asia/Tokyo').to_date
          elsif event.start.date
            Date.parse(event.start.date.to_s)
          else
            nil
          end
          event_date == day
        end
    %>
      <dialog id="day_modal_<%= day.strftime('%Y%m%d') %>" class="modal">
        <div class="modal-box max-w-2xl">
          <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
          </form>
          <h3 class="font-bold text-lg mb-4">
            <%= t('google_calendars.index.day_schedule', date: day.strftime("%Y年%m月%d日")) %>
            <% if events_for_day.present? %>
              (<%= events_for_day.size %>件)
            <% end %>
          </h3>

          <% if events_for_day.present? %>
            <div class="space-y-2">
              <% events_for_day.each do |event| %>
                <div class="card bg-base-200 hover:bg-base-300 cursor-pointer transition-colors"
                    onclick="document.getElementById('day_modal_<%= day.strftime('%Y%m%d') %>').close(); document.getElementById('event_modal_<%= event.id %>').showModal();">
                  <div class="card-body p-3">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-1 h-full rounded"
                          style="background-color: <%= event.respond_to?(:calendar_color) ? event.calendar_color : '#9fe1e7' %>;"></div>
                      <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-sm"><%= event.summary || t('google_calendars.index.no_title') %></h4>
                        <div class="flex items-center gap-4 mt-1 text-xs text-base-content/70">
                          <% if event.start.date_time %>
                            <div class="flex items-center gap-1">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <%= event.start.date_time.in_time_zone('Asia/Tokyo').strftime("%H:%M") %>
                              <% if event.end.date_time %>
                                - <%= event.end.date_time.in_time_zone('Asia/Tokyo').strftime("%H:%M") %>
                              <% end %>
                            </div>
                          <% elsif event.start.date %>
                            <div class="flex items-center gap-1">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                              </svg>
                              <%= t('google_calendars.index.all_day') %>
                            </div>
                          <% end %>
                          <% if event.respond_to?(:calendar_summary) && event.calendar_summary.present? %>
                            <span class="badge badge-xs"><%= event.calendar_summary %></span>
                          <% end %>
                        </div>
                        <% if event.location.present? %>
                          <div class="flex items-center gap-1 mt-1 text-xs text-base-content/60">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <%= event.location %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-8">
              <p class="text-sm text-base-content/60"><%= t('google_calendars.index.no_events') %></p>
            </div>
          <% end %>

          <div class="pt-3 border-t border-base-300 mt-4">
            <button onclick="document.getElementById('day_modal_<%= day.strftime('%Y%m%d') %>').close(); openNewEventModal('<%= day.to_s %>');" class="btn btn-primary btn-sm w-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <%= t('google_calendars.index.add_event') %>
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    <% end %>
  </div>
</div>

<!-- イベント詳細モーダル -->
<% @month_events.each do |event| %>
  <dialog id="event_modal_<%= event.id %>" class="modal">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <h3 class="font-bold text-lg mb-4"><%= event.summary || t('google_calendars.index.no_title') %></h3>

      <div class="space-y-3">
        <% if event.start.date_time %>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <p class="text-sm">
                <%= event.start.date_time.in_time_zone('Asia/Tokyo').strftime("%Y年%m月%d日 %H:%M") %>
                <% if event.end.date_time %>
                  - <%= event.end.date_time.in_time_zone('Asia/Tokyo').strftime("%H:%M") %>
                <% end %>
              </p>
            </div>
          </div>
        <% elsif event.start.date %>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p class="text-sm"><%= t('google_calendars.index.all_day') %></p>
          </div>
        <% end %>

        <% if event.location.present? %>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p class="text-sm"><%= event.location %></p>
          </div>
        <% end %>

        <% if event.description.present? %>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
            <p class="text-sm whitespace-pre-wrap"><%= event.description %></p>
          </div>
        <% end %>

        <% if event.respond_to?(:calendar_summary) && event.calendar_summary.present? %>
          <div class="pt-2 border-t border-base-300">
            <span class="badge badge-sm"><%= event.calendar_summary %></span>
          </div>
        <% end %>

        <% if event.respond_to?(:is_primary?) && event.is_primary? %>
          <div class="flex gap-2 pt-4 border-t border-base-300">
            <button type="button" onclick="openEditModal('<%= event.id %>', '<%= j event.summary %>', '<%= event.start.date_time&.to_date || event.start.date %>', '<%= event.start.date_time&.in_time_zone("Asia/Tokyo")&.strftime("%H:%M") || "00:00" %>', '<%= event.end.date_time&.in_time_zone("Asia/Tokyo")&.strftime("%H:%M") || "01:00" %>', '<%= j event.location.to_s %>', '<%= j event.description.to_s %>')" class="btn btn-sm btn-outline flex-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              <%= t('google_calendars.event_modal.edit') %>
            </button>
            <%= button_to google_calendar_path(event.id), method: :delete, class: "btn btn-sm btn-error btn-outline flex-1", data: { turbo: false, confirm: t('google_calendars.event_modal.delete_confirm') } do %>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              <%= t('google_calendars.event_modal.delete') %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>

<script>
// 編集モーダルを開く関数
function openEditModal(eventId, summary, startDate, startTime, endTime, location, description) {
  const form = document.getElementById('edit_event_form');
  form.action = `/google_calendars/${eventId}`;

  // フィールドに値を設定
  form.querySelector('[name="summary"]').value = summary;
  form.querySelector('[name="edit_start_date"]').value = startDate;
  form.querySelector('[name="edit_start_time"]').value = startTime;
  form.querySelector('[name="edit_end_time"]').value = endTime;
  form.querySelector('[name="location"]').value = location;
  form.querySelector('[name="description"]').value = description;

  // イベント詳細モーダルを閉じる
  document.querySelectorAll('.modal[open]').forEach(modal => modal.close());

  // 編集モーダルを開く
  document.getElementById('edit_event_modal').showModal();
}
</script>

<!-- 編集モーダル（Googleカレンダー風） -->
<dialog id="edit_event_modal" class="modal">
  <div class="modal-box max-w-2xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>

    <%= form_with url: "", method: :patch, id: "edit_event_form", class: "space-y-4", data: { turbo: false } do |f| %>
      <!-- タイトル（常に表示） -->
      <div>
        <%= text_field_tag :summary, nil, class: "input input-bordered input-lg w-full border-0 border-b border-base-300 rounded-none px-0 focus:border-primary focus:outline-none", placeholder: t('google_calendars.edit_modal.title_placeholder'), required: true %>
      </div>

      <!-- 日時入力 -->
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="flex-1 flex items-center gap-2">
            <%= date_field_tag :edit_start_date, nil, class: "input input-sm input-bordered", required: true %>
            <span class="text-sm">·</span>
            <%= time_field_tag :edit_start_time, nil, class: "input input-sm input-bordered", required: true %>
            <span class="text-sm text-base-content/50">-</span>
            <%= time_field_tag :edit_end_time, nil, class: "input input-sm input-bordered", required: true %>
          </div>
        </div>
      </div>

      <!-- 場所 -->
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <div class="flex-1">
          <%= text_field_tag :location, nil, class: "input input-sm input-bordered w-full", placeholder: t('google_calendars.edit_modal.location_placeholder') %>
        </div>
      </div>

      <!-- 説明 -->
      <div class="flex items-start gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/70 mt-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
        <div class="flex-1">
          <%= text_area_tag :description, nil, class: "textarea textarea-bordered w-full", rows: 3, placeholder: t('google_calendars.edit_modal.description_placeholder') %>
        </div>
      </div>

      <!-- アクションボタン -->
      <div class="flex justify-end gap-2 pt-4 border-t border-base-300">
        <button type="button" onclick="edit_event_modal.close()" class="btn btn-ghost"><%= t('google_calendars.edit_modal.cancel') %></button>
        <%= f.submit t('google_calendars.edit_modal.save'), class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
